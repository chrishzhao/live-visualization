<!DOCTYPE HTML>
<html>
	<head>
		<title>Live Visualization</title>

		<meta charset="utf-8">
		<link rel="stylesheet" href="css/reset.css" type="text/css" media="screen" charset="utf-8" />
		<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
		<script type="text/javascript" src="js/jq.js"></script>
		<script type="text/javascript" src="js/sb-1.4.1.js"></script>
		<script type="text/javascript" src="../rickshaw-master/vendor/d3.min.js"></script>
		<script type="text/javascript" src="../rickshaw-master/rickshaw.min.js"></script>
		<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
		<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
		<link type="text/css" rel="stylesheet" href="../rickshaw-master/rickshaw.min.css">
	</head>

	<body>
		<div id="graph"></div>
		<div id="x_axis"></div>
		</br></br>
		<div id="eeg_state">EEG: Not Connected</div>
		<div id="ecg_state">ECG: Not Connected</div>
		<div id="message">Please swipe your RFID tag to begin</div>
		<div id="central_circle"></div>

<script type="text/javascript">
		  
		  // variables to change 
			var display_params = ["alpha_relative","HRV"]; //change 
			var bufferLength = 120; 
			var port_in = 9000;
			var host = '127.0.0.1';

			// display messages
			var eeg_disconnected_text = "EEG: Not Connected";
			var ecg_disconnected_text = "ECG: Not Connected";

			var eeg_connected_text = "EEG: Connected";
			var ecg_connected_text = "ECG: Connected";

			var not_started_text = "Please swipe your RFID tag to begin";
			var start_ecg_calibration_text = "This booth requires approximately a three minute commitment. To continue, put on headphones, and place hands on sensors to begin";
			var baseline_collection_text = "give us 30 seconds to calibrate to your brain and body. please stay still and silent.";
			var query_text_1 = "how calm do you feel? type a number between 1 (not at all) and 9 (very) and hit enter";
			var query_text_2 = "how content are you? (1-9)";
    		var query_text_3 = "how distracted are you? (1-9)";
    		var query_text_0 = "did you complete the exercises correctly? type 1 for yes and 0 for no and hit enter";
    		var prompt_text =  "Choose practice to investigate: \n1: Conscious breathing \n2: Vipassana Meditation \n3: Zen Meditation\n Type number and enter or just enter for random selection:";
    		var guided_practice_text_1 = "In this practice, you will slow your breath to one breath every 8 seconds. Follow the inhalation/exhalation visual as closely as possible. As the circle expands, breathe in. As it shrinks breathe out.";
    		var guided_practice_text_2 = "In this practice you will simply observe your breath for 90 seconds. Breathe normally and feel the breath on your upper lip. Get curious about this subtle sensation and feel it as completely as possible! If you get distracted, just return attention to your lip without worry. In this practice, we need to blindfold you. Please put on the eye mask (hanging on the hook) below your headphones. If you are not comfortable with this you may instead commit to keep your eyes shut the whole time until you are told to open them. Once your hand returns to the sensor we will start.";
    		var guided_practice_text_3 = "";

    		var baseline_seconds = 30;
    		var condition_seconds = 90;

			// initialize program variables
			var program_state = "NOT_STARTED";
			var eeg_state = "DISCONNECTED";
			var ecg_state = "DISCONNECTED";

			var buffer = [];
			var sb, app_name = "Visualization"; //Biodata (ECG + EEG viz) is booth 5!
			var app_description = "Charts realtime alpha_relative to baseline (EEG) and HRV relative to baseline (ECG) data";

			// when window loads call the setup method
			$(window).on("load", setup);

			// Spacebrew Object
			
			//set up graph & axes in Rickshaw
			var chart = new Rickshaw.Graph( {
			element: document.querySelector("#graph"),
			width: 800,
			height: 400,
			renderer: 'line',
			series: [{
				color: 'steelblue',
				data: []
				}]
				});

			var xAxis = new Rickshaw.Graph.Axis.X({
    			graph: chart,
    			orientation: 'bottom',
				element: document.getElementById('x_axis')
				});
			xAxis.render();

			var yAxis = new Rickshaw.Graph.Axis.Y({
    		graph: chart
				});
			yAxis.render();

			/**
			* setup Function that connect to spacebrew and creates a listener for data being passed from biodata_spacebrew_client.py
			*/

			function setup (){

				// setup spacebrew
				sb = new Spacebrew.Client(host,app_name,app_description,{port:port_in});  // create spacebrew client object
				sb.addSubscribe("instruction", "string");

		        // create the spacebrew subscription channels
				sb.addSubscribe("alpha_relative", "string");		// create the subscription feed
				
				// configure the publication and subscription feeds
				sb.onStringMessage = onStringMessage;		
				sb.onOpen = onOpen;
				sb.onClose = onClose; 
				// connect to spacbrew
				sb.connect();  
				//$("#button").on("mousedown", onMouseDown);
			}
			/**
			 * Function that is called when Spacebrew connection is established
			 */
			function onOpen() {
				eeg_state = "CONNECTED"
				program_state = "START_ECG_CALIBRATION"
				update_ui()
			}

			function onClose() {
				var message = "Trying to connect";
				$("#state").html( message );
			}

			/**
			 * onStringMessage Function that is called whenever new spacebrew string messages are received.
			 *          It accepts two parameters:
			 * @param  {String} name    Holds name of the subscription feed channel
			 * @param  {String} value 	Holds value received from the subscription feed
			 */
			function onStringMessage( name, value ){
				console.log("[onStringMessage] string message received ", value);
				//$("#msg_received").text(value); // display the sent message in the browser 
				if (name == 'instruction')
				{					
					if (value == "BASELINE_COLLECTION")
					{
						program_state = value;
						start_baseline_timer(baseline_seconds);
						update_ui();
					}
				}
				if (buffer.length > bufferLength){
					buffer.shift();
				}
					buffer.push({"x":+value[1],"y":+value[2]});

				update_graph(buffer);  
			}
      

    		function update_graph(data)
    		{
    			chart.series[0].data = data;
    			chart.render(); 
    			//console.log(chart.series[0].data[0]);
    		}

    		function clear_graph()
    		{

    		}

    		function update_ui()
    		{
    			if (program_state == "NOT_STARTED")
    			{
    				$("#message").html( not_started_text );
    				$("#graph").hide();
    			}
    			else if (program_state == "START_ECG_CALIBRATION")
    			{
    				$("#message").html( start_ecg_calibration_text );
    				$("#graph").hide();
    			}
    			else if (program_state == "BASELINE_COLLECTION")
    			{
    				$("#message").html( baseline_collection_text );
    			}
    			else if (program_state == "CONDITION")
    			{
    				$("#graph").show();
    			}

    			if (eeg_state == "CONNECTED")
    			{
					$("#eeg_state").html( eeg_connected_text );
    			}
    			else if (eeg_state == "DISCONNECTED")
    			{
    				$("#eeg_state").html( eeg_disconnected_text );
    			}


    			if (ecg_state == "CONNECTED")
    			{
    				$("#ecg_state").html( ecg_connected_text );
    			}
    			else if (ecg_state == "DISCONNECTED")
    			{
					$("#ecg_state").html( ecg_disconnected_text );
    			}
    		}

    		function start_baseline_timer(seconds)
    		{

    		}

	    </script>
	</body>
</html>