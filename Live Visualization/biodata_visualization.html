<!DOCTYPE HTML>
<html>
    <head>
        <title>Live Visualization</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="css/reset.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="css/application.min.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="css/jquery.fullPage.css" type="text/css" media="screen" charset="utf-8" />
        <script type="text/javascript" src="js/jq.js"></script>
        <script type="text/javascript" src="js/sb-1.4.1.js"></script>
        <script type="text/javascript" src="../rickshaw-master/vendor/d3.min.js"></script>
        <script type="text/javascript" src="../rickshaw-master/rickshaw.min.js"></script>
        <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
        <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
        <script type="text/javascript" src="js/jquery.countdown360.js"></script>

        <link type="text/css" rel="stylesheet" href="../rickshaw-master/rickshaw.min.css">
    </head>
    <body class="background-dark">
        <div class="container">

            <header class="page-header">
                <div class="navbar">
                    <div class="logo pull-left">
                        <h2><a href="index.html">Change Your Mind</strong></a> <small>0.1</small></h2>
                    </div>
                </div>
            </header>

            <div class="content" id="fullpage">
                <div class="row section" id="section">
                    <div class="col-lg-12">
                        <section class="widget">
                            <header>
                                <h4>Instructions</h4>
                            </header>
                            <div id="instructions">"Please swipe your RFID tag to begin"</div>
                        </section>
                    </div>
                </div>

                <div class="row section" id="section">
                    <div class="col-lg-6">
                        <section class="widget">
                            <header>
                                <h4>EEG Baseline Collection</h4>
                            </header>
                            <div class="histogram">
                                <div id="eeg_graph_baseline"></div>
                            </div>
                        </section>
                        <section class="widget">
                            <header>
                                <h4>ECG Baseline Collection</h4>
                            </header>
                            <div class="histogram">
                                <div id="ecg_graph_baseline"></div>
                            </div>
                        </section>
                    </div>
                    <div class="col-lg-6">
                        <section class="widget">
                            <header>
                                <h4>More Information &nbsp;<span class="label label-danger">Instructions</span></h4>
                            </header>
                            <div class="widget-body">
                            <!-- <div id="msg-content"></div> -->
                                <div id="message"></div>
                                <div id="countdown"></div>
                            </div>
                        </section>
                    </div>
                </div>

                <div class="row section" id="section">
                    <div class="col-lg-6">
                        <section class="widget">
                            <header>
                                <h4>Baseline vs Actual</h4>
                            </header>
                            <div class="histogram">
                                <div id="eeg_graph_condition"></div>
                                <div id="legend"></div>
                                </br></br>
                                <div id="name">Trying to connect</div>
                            </div>
                        </section>
                        <section class="widget">
                            <header>
                                <h4>ECG Readings
                                    <small>Real-time Plot</small>
                                </h4>
                            </header>
                            <div class="histogram">
                                <div id="ecg_graph_condition"></div>
                                <div id="legend2"></div>
                                </br></br>
                                <div id="name">Trying to connect</div>
                            </div>
                        </section>
                    </div>
                    <div class="col-lg-6">
                        <section class="widget">
                            <header>
                                <h4>Breath
                                    <small>breathing visualization</small>
                                </h4>
                            </header>
                            <div id="bloom"></div>
                        </section>
                    </div>
                </div>

                <div class="row section" id="section">
                    <div class="col-lg-12">
                        <section class="widget">
                            <header>
                                <h4>Results Page</h4>
                            </header>
                            <div id="barchart1">pass</div>
                        </section>
                    </div>
                </div>

            </div>

        </div>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script type="text/javascript" src="js/bloom.js"></script>
        <script type="text/javascript">
            // variables to change
            var bufferLength = 120;
            var port_in = 9002;
            var host = '127.0.0.1';
            // display messages
            var eeg_disconnected_text = "EEG: Not Connected";
            var ecg_disconnected_text = "ECG: Not Connected";
            var eeg_connected_text = "EEG: Connected";
            var ecg_connected_text = "ECG: Connected";
            var not_started_text = "Please swipe your RFID tag to begin.";
            // initialize program variables
            var eeg_state = "DISCONNECTED";
            var ecg_state = "DISCONNECTED";
            var eeg_buffer = [];
            var ecg_buffer = [];

            var sb, app_name = "Change_your_mind"; //Biodata (ECG + EEG viz) is booth 5!
            var app_description = "Charts realtime alpha_relative to baseline (EEG) and HRV relative to baseline (ECG) data";
            // when window loads call the setup method
            $(window).on("load", setup);
            // Spacebrew Object
            //set up graph & axes in Rickshaw
            var eeg_graph_baseline = new Rickshaw.Graph( {
                element: document.querySelector("#eeg_graph_baseline"),
                width: 500,
                height: 200,
                renderer: 'line',
                series: [{
                    color: 'steelblue',
                data: []
                    }]
            });

            var ecg_graph_baseline = new Rickshaw.Graph( {
                element: document.querySelector("#ecg_graph_baseline"),
                width: 500,
                height: 200,
                renderer: 'line',
                series: [{
                    color: "rgb(207, 109, 81)",
                    data: []
                }]
            });

            var eeg_graph_condition = new Rickshaw.Graph( {
                element: document.querySelector("#eeg_graph_condition"),
                width: 500,
                height: 200,
                renderer: 'line',
                series: [{
                    color: 'steelblue',
                data: []
                    }]
            });

            var ecg_graph_condition = new Rickshaw.Graph( {
                element: document.querySelector("#ecg_graph_condition"),
                width: 500,
                height: 200,
                renderer: 'line',
                series: [{
                    color: "rgb(207, 109, 81)",
                    data: []
                }]
            });


var xAxis_eeg = new Rickshaw.Graph.Axis.X({
graph: eeg_graph_baseline,
orientation: 'bottom',
});
xAxis_eeg.render();

var yAxis_eeg = new Rickshaw.Graph.Axis.Y({
graph: eeg_graph_baseline
});
yAxis_eeg.render();

var xAxis_ecg = new Rickshaw.Graph.Axis.X({
graph: ecg_graph_baseline,
orientation: 'bottom',
});
xAxis_ecg.render();

var yAxis_ecg = new Rickshaw.Graph.Axis.Y({
graph: ecg_graph_baseline
});
yAxis_ecg.render();

var eeg_graph_to_plot = eeg_graph_baseline;
var ecg_graph_to_plot = ecg_graph_baseline;

var countdown = $("#countdown").countdown360({
    radius: 115,
    seconds: 60,
    label: ['sec', 'secs'],
    fontColor: '#FFFFFF',
    strokeStyle: '#f5f5f5',
    fillStyle: '#e5603b',
    autostart: false,
    onComplete: function () {
      console.log('done');
    }
});
/**
* setup Function that connect to spacebrew and creates a listener for data being passed from biodata_spacebrew_client.py
*/
function setup (){
// setup spacebrew
sb = new Spacebrew.Client(host,app_name,app_description,{port:port_in}); // create spacebrew client object
// create the spacebrew subscription channels
sb.addSubscribe("instruction", "string");
sb.addSubscribe("eeg_ecg", "string"); // create the subscription feed
// configure the publication and subscription feeds
sb.onStringMessage = onStringMessage;
sb.onOpen = onOpen;
sb.onClose = onClose;
// connect to spacbrew
sb.connect();
$(document).keypress(event,function(){
console.log(event);
console.log("key was presssed");
 var character = event.charCode;
 if (character == "49")
 {
 	$("#instructions").html("testing");
 	$(document).trigger('goTo',1);
 }
});
}
/**
* Function that is called when Spacebrew connection is established
*/
function onOpen() {
console.log("spacebrew client connection opened")
}
function onClose() {
var message = "Trying to connect";
$("#eeg_state").html( eeg_disconnected_text );
$("#ecg_state").html( ecg_disconnected_text );
$("#message").html( message );
}
/**
* onStringMessage Function that is called whenever new spacebrew string messages are received.
* It accepts two parameters:
* @param {String} name Holds name of the subscription feed channel
* @param {String} value Holds value received from the subscription feed
*/
function onStringMessage( name, value ){
console.log("[onStringMessage] string message received ", value);
//$("#msg_received").text(value); // display the sent message in the browser
if (name == 'instruction')
{
	update_ui(value);
}
else if (name == "eeg_ecg")
{
	/*var ecg_point = value['ecg'];
	var eeg_point = value['alpha_absolute'];
	graph.series[0].addData(ecg_point)
	graph.series[1].addData(eeg_point)*/
	var timestamp = +value[0];
	var eeg_point = +value[1];
	var ecg_point = +value[2];

	if (eeg_buffer.length > bufferLength){
		eeg_buffer.shift();
	}
	eeg_buffer.push({"x":timestamp,"y":eeg_point});

	if (ecg_buffer.length > bufferLength){
		ecg_buffer.shift();
	}
	ecg_buffer.push({"x":timestamp,"y":ecg_point});

	update_graph(eeg_buffer,eeg_graph_to_plot);
	update_graph(ecg_buffer,ecg_graph_to_plot);

	}
}

function update_graph(data,graph)
{
graph.series[0].data = data;
graph.render();
//console.log(chart.series[0].data[0]);
}

function clear_graph()
{
}

function update_ui(instruction)
{
    if (instruction.instruction_name == "DISPLAY_INSTRUCTION")
    {
      var message = instruction.instruction_text;
      $("#instructions").html(message)
      $(document).trigger('goTo',1);

    }
    else if (instruction.instruction_name == "BASELINE_COLLECTION")
    {
        console.log("baseline collection started");
        var baseline_seconds = instruction.display_time;
        // start timer
        eeg_graph_to_plot = eeg_graph_baseline;
        ecg_graph_to_plot = ecg_graph_baseline;

        start_baseline_timer(baseline_seconds);
        $(document).trigger('goTo',2);

    }
    else if (instruction.instruction_name == "CONDITION_COLLECTION")
    {
        console.log("condition began");
	   var display_seconds = instruction.display_seconds;
        eeg_graph_to_plot = eeg_graph_condition;
        ecg_graph_to_plot = ecg_graph_condition;

	   $(document).trigger('goTo',3);
    }
    else if (instruction.instruction_name == "POST_EXPERIMENT")
    {
	   $(document).trigger('goTo',4);
    }
    else if (instruction.instruction_name == "CONNECTED")
    {
	   if (instruction.type == "eeg"){
		  $("#eeg_state").html( eeg_connected_text );
	   }
	else if (instruction.type == "ecg")
	{
		$("#ecg_state").html( eeg_connected_text );
	}
}

else if (instruction.instruction_name == "DISCONNECTED")
{
	if (instruction.type == "eeg"){
		$("#eeg_state").html( eeg_connected_text );
	}
	else if (instruction.type == "ecg")
	{
		$("#ecg_state").html( eeg_connected_text );
	}

}
}

function start_baseline_timer(seconds)
{
    console.log("start baseline timer called");
    countdown.start();
}

</script>
<script type="text/javascript" src="js/countdown.js"></script>
<script type="text/javascript" src="js/jquery.fullPage.js"></script>
<script type="text/javascript" src="js/main.js"></script>
</body>
</html>