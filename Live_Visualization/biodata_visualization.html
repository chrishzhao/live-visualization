<!DOCTYPE HTML>
<html>
    <head>
        <title>Live Visualization</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="css/reset.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="css/application.min.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="css/jquery.fullPage.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="css/radar-chart.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
        <script type="text/javascript" src="js/jq.js"></script>
        <script type="text/javascript" src="js/sb-1.4.1.js"></script>
        <script type="text/javascript" src="../rickshaw-master/vendor/d3.min.js"></script>
        <script type="text/javascript" src="../rickshaw-master/rickshaw.min.js"></script>
        <script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
        <script type="text/javascript" src="js/jquery-migrate-1.2.1.min.js"></script>
        <script type="text/javascript" src="js/jquery.countdown360.js"></script>

        <link type="text/css" rel="stylesheet" href="../rickshaw-master/rickshaw.min.css">
    </head>
    <body class="background-dark">
        <div class="container">

            <header class="page-header">
                <div class="navbar">
                    <div class="logo pull-left">
                        <h2><a href="index.html">Change Your Mind</strong></a> <small>0.1</small></h2>
                    </div>
                    <ul class="nav navbar-nav navbar-right pull-right">
                        <li class="connection">
                            <i class="fa fa-circle text-success"></i>
                            <span class="label-name" id="connected">EEG Connected</span>
                        </li>
                        <li class="connection">
                            <i class="fa fa-circle text-danger"></i>
                            <span class="label-name" id="not-connected">EEG Not Connected</span>
                        </li>
                    </ul>
                </div>
            </header>

            <div class="content" id="fullpage">
                <div class="row section" id="section">
                    <div class="col-lg-12">
                        <section class="widget">
                            <header>
                                <h4>Instructions</h4>
                            </header>
                            <div id="instructions">"Please swipe your RFID tag to begin"</div>
                        </section>
                    </div>
                </div>

                <div class="row section" id="section">
                    <div class="col-lg-5">
                        <section class="widget">
                            <header>
                                <h4>EEG Baseline Collection</h4>
                            </header>
                            <div class="histogram">
                                <div id="eeg_graph_baseline"></div>
                                <div id="eeg_legend_baseline"></div>
                                <br><br>
                                 <div id="eeg_state_baseline">Trying to connect</div>
                            </div>
                        </section>
                        <section class="widget">
                            <header>
                                <h4>ECG Baseline Collection</h4>
                            </header>
                            <div class="histogram">
                                <div id="ecg_graph_baseline"></div>
                                <div id="ecg_legend_baseline"></div>
                                <br><br>
                                 <div id="ecg_state_baseline">Trying to connect</div>
                            </div>
                        </section>
                    </div>
                    <div class="col-lg-5">
                        <section class="widget">
                            <header>
                                <h4>More Information &nbsp;<span class="label label-danger">Instructions</span></h4>
                            </header>
                            <div class="widget-body">
                            <!-- <div id="msg-content"></div> -->
                                <div id="message"></div>
                                <div id="countdown"></div>
                            </div>
                        </section>
                    </div>
                </div>

                <div class="row section" id="section">
                    <div class="col-lg-5">
                        <section class="widget">
                            <header>
                                <h4>Baseline vs Actual</h4>
                            </header>
                            <div class="histogram">
                                <div id="eeg_graph_condition"></div>
                                <div id="eeg_legend_condition"></div>
                                </br></br>
                                <div id="eeg_state_condition">Trying to connect</div>
                            </div>
                        </section>
                        <section class="widget">
                            <header>
                                <h4>ECG Readings
                                    <!-- <small>Real-time Plot</small> -->
                                </h4>
                            </header>
                            <div class="histogram">
                                <div id="ecg_graph_condition"></div>
                                <div id="ecg_legend_condition"></div>
                                </br></br>
                                <div id="ecg_state_condition">Trying to connect</div>
                            </div>
                        </section>
                    </div>
                    <div class="col-lg-5">
                        <section class="widget">
                            <header>
                                <h4>Breath
                                    <!-- <small>breathing visualization</small> -->
                                </h4>
                            </header>
                            <div id="bloom"></div>
                        </section>
                    </div>
                </div>

                <div class="row section" id="section">
                <!-- <div class="row section" id="section"> -->
                    <div class="col-lg-8">
                        <section class="widget">
                            <div id="barchart1">
                                <div style="width: 100%">
                                    <canvas id="canvas" height="250" width="600"></canvas>
                                </div>
                            </div>
                        </section>
                        <section class="widget">
                            <div class="chart-container">
                                <div id="radar-chart"></div>
                            </div>
                        </section>
                    </div>
                    <div class="col-md-4">
                        <div class="box">
                            <div class="big-text">
                                33% increase
                            </div>
                            <div class="description">
                                Heart Rate Variability
                            </div>
                        </div>
                        <div class="box">
                            <div class="big-text">
                                55% decrease
                            </div>
                            <div class="description">
                                EEG Alpha
                            </div>
                        </div>
                    </div>
                <!-- </div> -->
                </div>
            </div>

        </div>
        <script type="text/javascript" src="js/d3.v3.min.js"></script>
        <script type="text/javascript" src="js/bloom.js"></script>
        <script type="text/javascript">
            // variables to change
            var bufferLength = 120;
            var port_in = 9002;
            var host = '127.0.0.1';
            // display messages
            var eeg_disconnected_text = "EEG: Not Connected";
            var ecg_disconnected_text = "ECG: Not Connected";
            var eeg_connected_text = "EEG: Connected";
            var ecg_connected_text = "ECG: Connected";
            var not_started_text = "Please swipe your RFID tag to begin.";
            // initialize program variables
            var eeg_state = "DISCONNECTED";
            var ecg_state = "DISCONNECTED";
            var eeg_buffer = [];
            var ecg_buffer = [];

            var sb, app_name = "Change_your_mind"; //Biodata (ECG + EEG viz) is booth 5!
            var app_description = "Charts realtime alpha_relative to baseline (EEG) and HRV relative to baseline (ECG) data";
            // when window loads call the setup method
            $(window).on("load", setup);
            // Spacebrew Object
            //set up graph & axes in Rickshaw

            var graph_height = 300;
            var graph_width = 500;

            var eeg_graph_baseline = new Rickshaw.Graph( {
                element: document.querySelector("#eeg_graph_baseline"),
                width: graph_width,
                height: graph_height,
                renderer: 'line',
                series: [{
                    color: 'steelblue',
                    data: [],
                    name: "EEG"
                    }]
            });

            var ecg_graph_baseline = new Rickshaw.Graph( {
                element: document.querySelector("#ecg_graph_baseline"),
                width: graph_width,
                height: graph_height,
                renderer: 'line',
                series: [{
                    color: "rgb(207, 109, 81)",
                    data: [],
                    name: "ECG"
                }]
            });

            var eeg_graph_condition = new Rickshaw.Graph( {
                element: document.querySelector("#eeg_graph_condition"),
                width: graph_width,
                height: graph_height,
                renderer: 'line',
                series: [{
                    color: 'steelblue',
                     data: [],
                     name: "EEG"
                    },
                    {
                    color: 'black',
                     data: [],
                     name: "EEG_average_baseline"
                    }
                    ]
            });

            var ecg_graph_condition = new Rickshaw.Graph( {
                element: document.querySelector("#ecg_graph_condition"),
                width: graph_width,
                height: graph_height,
                renderer: 'line',
                series: [{
                    color: "rgb(207, 109, 81)",
                    data: [],
                    name: "ECG"
                },
                {
                    color: 'black',
                    data: [],
                    name: "ECG_average_baseline"
                    }]
            });
            make_axes();

            var legend_1 = new Rickshaw.Graph.Legend({
                graph: eeg_graph_baseline,
                element: document.querySelector('#eeg_legend_baseline')
            });
            var legend_2 = new Rickshaw.Graph.Legend({
                graph: ecg_graph_baseline,
                element: document.querySelector('#ecg_legend_baseline')
            });
            var legend_3 = new Rickshaw.Graph.Legend({
                graph: eeg_graph_condition,
                element: document.querySelector('#eeg_legend_condition')
            });
            var legend_4 = new Rickshaw.Graph.Legend({
                graph: eeg_graph_baseline,
                element: document.querySelector('#ecg_legend_condition')
            });

            legend_1.render();
            legend_2.render();
            legend_3.render();
            legend_4.render();

            var eeg_graph_to_plot = eeg_graph_baseline;
            var ecg_graph_to_plot = ecg_graph_baseline;

/**
* setup Function that connect to spacebrew and creates a listener for data being passed from biodata_spacebrew_client.py
*/
function setup (){
// setup spacebrew
    sb = new Spacebrew.Client(host,app_name,app_description,{port:port_in}); // create spacebrew client object
    // create the spacebrew subscription channels
    sb.addSubscribe("instruction", "string");
    sb.addSubscribe("eeg_ecg", "string"); // create the subscription feed
    // configure the publication and subscription feeds
    sb.onStringMessage = onStringMessage;
    sb.onOpen = onOpen;
    sb.onClose = onClose;
    // connect to spacbrew
    sb.connect();

    //remove this later
    $(document).keypress(event,function(){
        console.log(event);
        console.log("key was presssed");
        var character = event.charCode;
        if (character == "49")
        {
 	      $("#instructions").html("testing");
 	      $(document).trigger('goTo',1);
        }
    });
}
/**
* Function that is called when Spacebrew connection is established
*/
function onOpen() {
    console.log("spacebrew client connection opened")
    $("#eeg_state_baseline").html( eeg_connected_text );
    $("#eeg_state_condition").html( eeg_connected_text );
}

function onClose() {
    var message = "Trying to connect";
    $("#eeg_state_baseline").html( eeg_disconnected_text );
    $("#ecg_state_baseline").html( ecg_disconnected_text );
    $("#eeg_state_condition").html( eeg_disconnected_text );
    $("#ecg_state_condition").html( ecg_disconnected_text );
    $("#message").html( message );
}
/**
* onStringMessage Function that is called whenever new spacebrew string messages are received.
* It accepts two parameters:
* @param {String} name Holds name of the subscription feed channel
* @param {String} value Holds value received from the subscription feed
*/
function onStringMessage( name, value ){
console.log("[onStringMessage] string message received ", value);
//$("#msg_received").text(value); // display the sent message in the browser
if (name == 'instruction')
{
	update_ui(value);
}
else if (name == "eeg_ecg")
{
    var arrVal = value.split(",");

	var timestamp = +arrVal[0];
	var eeg_point = +arrVal[1];
	var ecg_point = +arrVal[2];

    //console.log("eeg point " + eeg_point)

	if (eeg_buffer.length > bufferLength){
		eeg_buffer.shift();
	}
	eeg_buffer.push({"x":timestamp,"y":eeg_point});

	if (ecg_buffer.length > bufferLength){
		ecg_buffer.shift();
	}
	ecg_buffer.push({"x":timestamp,"y":ecg_point});

	update_graph(eeg_buffer,eeg_graph_to_plot);
	update_graph(ecg_buffer,ecg_graph_to_plot);

	}
}

function update_graph(data,graph)
{
    graph.series[0].data = data;
    graph.render();
    //console.log(chart.series[0].data[0]);
}

function clear_graph()
{
}

function update_ui(instruction)
{
    if (instruction.instruction_name == "DISPLAY_INSTRUCTION")
    {
      var message = instruction.instruction_text;
      $("#instructions").html(message)
      $(document).trigger('goTo',1);
    }
    else if (instruction.instruction_name == "BASELINE_COLLECTION")
    {
        console.log("baseline collection started");
        var baseline_seconds = instruction.display_seconds;
        // start timer
        eeg_graph_to_plot = eeg_graph_baseline;
        ecg_graph_to_plot = ecg_graph_baseline;

        start_baseline_timer(baseline_seconds);
        $(document).trigger('goTo',2);

    }
    else if (instruction.instruction_name == "CONDITION_COLLECTION")
    {
       console.log("condition began");
	   var display_seconds = instruction.display_seconds;
       eeg_buffer = [];
       ecg_buffer = [];
       //var alpha_avg_baseline = instruction.baseline_alpha;
       //var hrv_avg_baseline =  instruction.baseline_hrv;

       var alpha_avg_baseline = 0.3;
       var hrv_avg_baseline =  0.3;

        eeg_graph_to_plot = eeg_graph_condition;
        //d3.select("body").append("svg")
        //.attr("class", "axis")
        //.attr("width", eeg_graph_to_plot.width)
        //.attr("height", 30)
        //d3.enter();
        //var baseline_series = makeAverageBaseline(alpha_avg_baseline,eeg_graph_condition.series[0].data)
        //eeg_graph_condition.series[1].data = baseline_series;

        //console.log("baseline series:" + baseline_series)

        ecg_graph_to_plot = ecg_graph_condition;
        //ecg_graph_condition.series[1].data = baseline_series;

	   $(document).trigger('goTo',3);
    }
    else if (instruction.instruction_name == "POST_EXPERIMENT")
    {
	   $(document).trigger('goTo',4);
    }
    else if (instruction.instruction_name == "CONNECTED")
    {
	   if (instruction.type == "eeg"){
		  $("#eeg_state_baseline").html( eeg_connected_text );
          $("#eeg_state_condition").html( eeg_connected_text );

	   }
	else if (instruction.type == "ecg")
	{
		$("#ecg_state_baseline").html( eeg_connected_text );
        $("#ecg_state_condition").html( eeg_connected_text );
	}
}

else if (instruction.instruction_name == "DISCONNECTED")
{
	if (instruction.type == "eeg"){
		$("#eeg_state_baseline").html( eeg_connected_text );
        $("#eeg_state_condition").html( eeg_connected_text );
	}
	else if (instruction.type == "ecg")
	{
		$("#ecg_state_baseline").html( eeg_connected_text );
        $("#ecg_state_condition").html( eeg_connected_text );
	}

}
}

function start_baseline_timer(seconds)
{
    console.log("start baseline timer called with " + seconds + " seconds");
                var countdown = $("#countdown").countdown360({
                 radius: 115,
                 seconds: seconds,
                 label: ['sec', 'secs'],
                fontColor: '#FFFFFF',
                 strokeStyle: '#f5f5f5',
                 fillStyle: '#e5603b',
                 autostart: false,
                 onComplete: function () {
                      console.log('done');
                 }
            });
    countdown.start();
}


function make_graphs()
{

}

function make_axes()
{
    var xAxis_eeg = new Rickshaw.Graph.Axis.X({
                graph: eeg_graph_baseline,
                orientation: 'bottom',
                });
    xAxis_eeg.render();

    var yAxis_eeg = new Rickshaw.Graph.Axis.Y({
                graph: eeg_graph_baseline
                });
    yAxis_eeg.render();

    var xAxis_ecg = new Rickshaw.Graph.Axis.X({
                graph: ecg_graph_baseline,
                orientation: 'bottom',
                });
    xAxis_ecg.render();

    var yAxis_ecg = new Rickshaw.Graph.Axis.Y({
                graph: ecg_graph_baseline
                });
    yAxis_ecg.render();

    var xAxis_eeg_cond = new Rickshaw.Graph.Axis.X({
                graph: eeg_graph_condition,
                orientation: 'bottom',
                });
    xAxis_eeg_cond.render();

    var yAxis_eeg_cond = new Rickshaw.Graph.Axis.Y({
                graph: eeg_graph_condition
                });
    yAxis_eeg_cond.render();

    var xAxis_ecg_cond = new Rickshaw.Graph.Axis.X({
                graph: ecg_graph_condition,
                orientation: 'bottom',
                });
    xAxis_ecg_cond.render();

    var yAxis_ecg_cond = new Rickshaw.Graph.Axis.Y({
                graph: ecg_graph_condition
                });
    yAxis_ecg_cond.render();
}

function makeAverageBaseline(value, buffer) {
  var arr = [];
  for (var i = 0; i < buffer.length; i++) {
    arr.push({"x":buffer[i].x,"y":value});
  }
  return arr;
}

</script>
<!--<script type="text/javascript" src="js/countdown.js"></script>-->
<script type="text/javascript" src="js/Chart.js"></script>
<script type="text/javascript" src="js/jquery.fullPage.js"></script>
<script type="text/javascript" src="js/radar-chart.js"></script>
<script type="text/javascript" src="js/main.js"></script>
</body>
</html>